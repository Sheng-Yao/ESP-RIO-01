<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Login</title>
    <link rel="stylesheet" href="/style.css" />
  </head>

  <body>
    <div class="box">
      <div class="section">
        <h3 style="text-align: center; margin-bottom: 12px">
          ESP-RIO-01 Login
        </h3>

        <label for="u">Username</label>
        <input id="u" autocomplete="username" />

        <label for="p">Password</label>
        <input id="p" type="password" autocomplete="current-password" />

        <button id="btn">Login</button>
        <div id="msg" class="msg"></div>

        <div class="smallnote">
          If another client is active, a new login may take over the session.
        </div>
      </div>
    </div>

    <script>
      (() => {
        const $ = (id) => document.getElementById(id);
        const u = $("u"),
          p = $("p"),
          btn = $("btn"),
          msg = $("msg");

        function setMsg(text, ok) {
          msg.className = "msg " + (ok ? "ok" : "err");
          msg.textContent = text || "";
        }

        // Show reason if redirected here
        const params = new URLSearchParams(location.search);
        const reason = params.get("reason");

        if (reason === "kicked") {
          setMsg(
            "You were logged out because another client logged in.",
            false
          );
        }

        async function login() {
          setMsg("", true);
          const user = u.value.trim();
          const pass = p.value;

          if (!user) {
            setMsg("Username is required.", false);
            return;
          }
          if (!pass) {
            setMsg("Password is required.", false);
            return;
          }

          btn.disabled = true;
          setMsg("Signing in...", true);

          try {
            const ctrl = new AbortController();
            setTimeout(() => ctrl.abort(), 5000);

            const r = await fetch("/api/login", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body:
                "username=" +
                encodeURIComponent(user) +
                "&password=" +
                encodeURIComponent(pass),
              credentials: "include",
              signal: ctrl.signal,
            });

            const t = (await r.text()).trim();

            if (r.ok && (t.toUpperCase() === "OK" || t === "")) {
              location = "/index.html#status";
              return;
            }

            if (r.status === 409) {
              setMsg(
                "Another client is active. Login will take over (if enabled).",
                false
              );
            } else if (r.status === 503 || r.status === 429) {
              setMsg(
                "Login temporarily unavailable. Too many clients connected.",
                false
              );
            } else {
              setMsg("Invalid username or password.", false);
            }
          } catch (e) {
            setMsg("Connection error or timeout.", false);
          } finally {
            btn.disabled = false;
          }
        }

        btn.addEventListener("click", (e) => {
          e.preventDefault();
          login();
        });
        p.addEventListener("keydown", (e) => {
          if (e.key === "Enter") login();
        });
      })();
    </script>
  </body>
</html>
