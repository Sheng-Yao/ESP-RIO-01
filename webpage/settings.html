<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Settings</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="box">
      <div class="header">
        <div class="device">ESP-RIO-01</div>
        <div class="fw" id="fw">Firmware: --</div>
      </div>

      <h3>Wi-Fi</h3>
      <div id="list" class="empty">Loading...</div>

      <div class="section">
        <form id="f" enctype="multipart/form-data">
          <input type="hidden" name="id" />
          <input name="ssid" placeholder="SSID" required />
          <input name="pass" id="wifiPass" placeholder="Password" />

          <div class="row">
            <span>Enterprise</span>
            <input type="checkbox" id="e" />
          </div>

          <input
            name="user"
            id="u"
            placeholder="Enterprise User"
            style="display: none"
          />
          <input type="file" name="cert" id="c" style="display: none" />

          <input
            name="mac"
            placeholder="MAC Address"
            pattern="^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$"
            title="Format: AA:BB:CC:DD:EE:FF"
          />
          <input name="prio" placeholder="Priority" />
          <button>Save</button>
          <button
            type="button"
            id="del"
            disabled
            style="background-color: #999; color: white"
          >
            Delete
          </button>
        </form>
      </div>

      <form id="loginForm">
        <input id="cp" name="cu" type="password" placeholder="Current Pass" />
        <input id="nu" name="u" placeholder="New User" />
        <input id="np" name="p" type="password" placeholder="New Pass" />
        <button type="button" id="ls">Save Login</button>
      </form>

      <div id="statusMsg" style="margin-top: 8px; font-size: 14px"></div>

      <a href="/index.html">‚Üê Back</a>
    </div>

    <script>
      const WIFI_PROFILE_SIZE = 144; // MUST match sizeof(wifi_profile_t)

      const loginForm = document.getElementById("loginForm");
      const wifiPass = document.getElementById("wifiPass");

      function writeString(view, offset, str, max) {
        for (let i = 0; i < max; i++) {
          view.setUint8(offset + i, i < str.length ? str.charCodeAt(i) : 0);
        }
      }

      fetch("/api/info")
        .then((r) => r.json())
        .then((i) => (fw.textContent = "Firmware: " + i.fw));

      e.onchange = () => {
        u.style.display = c.style.display = e.checked ? "block" : "none";
      };

      function updatePasswordPlaceholder() {
        wifiPass.placeholder = f.id.value
          ? "Leave blank to keep current password"
          : "Password";
      }

      function updateDeleteState() {
        if (f.id.value) {
          del.disabled = false;
          del.style.backgroundColor = "red";
          del.style.cursor = "pointer";
        } else {
          del.disabled = true;
          del.style.backgroundColor = "#999";
          del.style.cursor = "not-allowed";
        }
        del.style.opacity = del.disabled ? "0.6" : "1";
      }

      f.id.onchange = updateDeleteState;
      updateDeleteState();

      function load() {
        fetch("/wifi/list", { credentials: "include" })
          .then((r) => r.json())
          .then((d) => {
            list.innerHTML = "";
            if (!d.length) {
              list.className = "empty";
              list.textContent = "No Wi-Fi";
              return;
            }
            list.className = "";
            d.forEach((w) => {
              let div = document.createElement("div");
              div.className = "w";
              div.textContent =
                w.ssid +
                " (prio " +
                w.priority +
                ")" +
                (w.has_bssid ? " üîí" : "");

              div.onclick = () => {
                f.id.value = w.id;
                f.ssid.value = w.ssid;
                f.pass.value = ""; // NEVER preload password
                f.prio.value = w.priority ?? 0;
                f.mac.value = w.has_bssid ? w.bssid : "";
                e.checked = w.ent || 0;
                e.onchange();
                u.value = w.user || "";
                updatePasswordPlaceholder();
                updateDeleteState(); // ‚Üê ADD THIS
              };
              list.appendChild(div);
            });
          });
      }

      del.onclick = () => {
        if (!f.id.value) {
          alert("No Wi-Fi selected");
          return;
        }

        if (!confirm("Delete this Wi-Fi profile?")) return;

        fetch("/wifi/delete", {
          method: "POST",
          body: f.id.value,
          credentials: "include",
        })
          .then((r) => r.json())
          .then((j) => {
            alert(j.message || "Deleted");

            // Clear form
            f.reset();
            f.id.value = "";
            updatePasswordPlaceholder();
            updateDeleteState();

            // Reload list
            load();
          })
          .catch(() => alert("Delete failed"));
      };

      f.ssid.oninput = () => {
        if (!f.id.value) updateDeleteState();
      };

      f.onsubmit = (e2) => {
        e2.preventDefault();

        const buf = new ArrayBuffer(WIFI_PROFILE_SIZE);
        const v = new DataView(buf);

        // Zero buffer
        for (let i = 0; i < WIFI_PROFILE_SIZE; i++) v.setUint8(i, 0);

        // Offsets MUST match wifi_profile_t
        writeString(v, 0, f.ssid.value, 32);
        writeString(v, 32, f.pass.value, 64);
        writeString(v, 96, u.value || "", 32);

        v.setUint32(128, e.checked ? 1 : 0, true); // auth_type

        // priority, min_rssi
        v.setUint8(132, parseInt(f.prio.value || "0", 10));
        v.setInt8(133, -100);

        if (f.mac.value) {
          v.setUint8(134, 1); // has_bssid
          f.mac.value.split(":").forEach((b, i) => {
            v.setUint8(135 + i, parseInt(b, 16));
          });
        } else {
          v.setUint8(134, 0);
          for (let i = 0; i < 6; i++) v.setUint8(135 + i, 0);
        }

        fetch("/wifi/save", {
          method: "POST",
          body: buf,
          credentials: "include",
        }).then(load);
      };

      ls.onclick = () => {
        const params = new URLSearchParams();
        params.append("cu", cp.value);
        params.append("u", nu.value);
        params.append("p", np.value);

        fetch("/login/save", {
          method: "POST",
          body: params,
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          credentials: "include",
        })
          .then((r) => r.json())
          .then((j) => {
            const msg = document.getElementById("statusMsg");
            msg.style.color = j.status === "ok" ? "green" : "red";
            msg.textContent = j.message;
          });
      };

      updatePasswordPlaceholder();
      load();
    </script>
  </body>
</html>
